<?xml version="1.0" encoding="utf-8"?>
<TestSuite
  xmlns:tei="http://www.tei-c.org/ns/1.0"
  xmlns:j="http://jewishliturgy.org/ns/jlptei/1.0"
  xmlns:jx="http://jewishliturgy.org/ns/jlp-processor"
  xmlns:http="http://expath.org/ns/http-client">
  <suiteName>API index test</suiteName>
  <description>
    <p>Test the user API index</p>
    <author>Efraim Feinstein</author>
  </description>
  <setup/>
  <namespace prefix="html">http://www.w3.org/1999/xhtml</namespace>
  <imports>
    import module namespace apitest="http://jewishliturgy.org/modules/apitest"
      at "xmldb:exist:///code/tests/api/apitest.xqm";
  </imports>
  <functions><![CDATA[
    declare function local:auth-header() {
      element header {
        attribute name {"Authorization"},
        attribute value { 
          concat("Basic ",
            util:base64-encode("testuser:testuser"))
        }
      }
    };
  ]]></functions>
  <TestSet>
    <testName>HTTP GET while logged out</testName>
    <setup/>
    <imports>
    </imports>
    <functions>
    </functions>
    <tearDown/>
    <test>
      <task>GET without being logged in</task>
      <code><![CDATA[
        apitest:get("/code/api/user", <header name="Accept" value="application/xhtml+xml"/>)
      ]]></code>
      <xpath desc="No users are listed in the results section">empty(.//html:ul[@class="results"]/*)</xpath>
      <xpath desc="Services are listed in the common section">count(.//html:ul[@class="common"]/html:li/html:a[@class="service"]) &gt; 0</xpath>
      <class href="../common.t.xml#SelfConsistentMenu"/> 
      <class href="../common.t.xml#Testing"/> 
    </test>
    <test>
      <task>GET accepting text/plain</task>
      <code><![CDATA[
        apitest:get("/code/api/user", <header name="Accept" value="text/plain"/>)
      ]]></code>
      <class href="../common.t.xml#Unacceptable"/>
    </test>
  </TestSet>
  <TestSet>
    <testName>HTTP GET while logged in</testName>
    <setUp></setUp>
    <test>
      <task>GET while logged in with HTTP Basic</task>
      <code><![CDATA[
        apitest:get("/code/api/user", 
          (<header name="Accept" value="application/xhtml+xml"/>,
          local:auth-header()
          ))
      ]]></code>
      <xpath desc="Exactly one user is listed in the results section">count(.//html:ul[@class="results"]/html:li) = 1</xpath>
      <xpath desc="Services are listed in the common section">count(.//html:ul[@class="common"]/html:li/html:a[@class="service"]) &gt; 0</xpath>
      <class href="../common.t.xml#SelfConsistentMenu"/> 
      <class href="../common.t.xml#Testing"/>
    </test>
  </TestSet>
  <TestSet>
    <testName>HTTP PUT</testName>
    <test>
      <task>PUT</task>
      <code><![CDATA[
        apitest:put("/code/api/user", (), <x/>)
      ]]></code>
      <class href="../common.t.xml#InvalidMethod"/>
    </test>
  </TestSet>
  <TestSet>
    <testName>HTTP POST</testName>
    <test>
      <task>POST</task>
      <code><![CDATA[
        apitest:post("/code/api", (), <x/>)
      ]]></code>
      <class href="../common.t.xml#InvalidMethod"/> 
    </test>
  </TestSet>
  <TestSet>
    <testName>HTTP DELETE</testName>
    <test>
      <task>DELETE</task>
      <code><![CDATA[
        apitest:delete("/code/api", ())
      ]]></code>
      <class href="../common.t.xml#InvalidMethod"/> 
    </test>
  </TestSet>
</TestSuite>